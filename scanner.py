import subprocess

def nmap_scanner(domain):
    Nmap = subprocess.Popen(["nmap", "-sV", "-Pn", "-p-", domain],
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE,
                            universal_newlines=True
                            )

    vulnerabilities = subprocess.Popen(["nmap", "-sV", "--script=vulners.nse", domain],
                                        stdout=subprocess.PIPE,
                                        stderr=subprocess.PIPE,
                                        universal_newlines=True
                                        )

    Slowris = subprocess.Popen(["nmap", "-Pn", "--script=http-slowloris-check", domain],
                                stdout=subprocess.PIPE,
                                stderr=subprocess.PIPE,
                                universal_newlines=True
                                )

    Ciphers = subprocess.Popen(["nmap", "-sV", "--script ssl-enum-ciphers", "-p443", domain],
                                stdout=subprocess.PIPE,
                                stderr=subprocess.PIPE,
                                universal_newlines=True
                                )

    DiffieHellman = subprocess.Popen(["nmap", "--script=ssl-dh-params", domain],
                                        stdout=subprocess.PIPE,
                                        stderr=subprocess.PIPE,
                                        universal_newlines=True
                                        )

    Heartbleed = subprocess.Popen(["nmap", "-sV", "--script ssl-heartbleed", "-p443", domain],
                                    stdout=subprocess.PIPE,
                                    stderr=subprocess.PIPE,
                                    universal_newlines=True
                                    )

    Poodle = subprocess.Popen(["nmap", "-sV", "-ersion-light", "--script=ssl-poodle", "-p443", domain],
                                stdout=subprocess.PIPE,
                                stderr=subprocess.PIPE,
                                universal_newlines=True
                                )





def scanner(url, namp, header, testssl, dirsearch):
    if namp:
        domain = url.replace("https://", "").replace("http://", "").replace("/", "")
        nmap_scanner(domain)
    if header:
        headers = subprocess.Popen(["python3", "shcheck.py", "{}".format(url), "-i", "-k", "-d"],
						   stdout=subprocess.PIPE,
						   stderr=subprocess.PIPE,
						   universal_newlines=True
						   )
    if testssl:
        Testssl = subprocess.Popen(["testssl", url],
                        stdout=subprocess.PIPE,
                        stderr=subprocess.PIPE,
                        universal_newlines=True
                        )
    if dirsearch:
        Dirsearch = subprocess.Popen(
						    ["dirsearch",
						     "-u", url,
						     "-e", "php,js,json,zip,css,gz,zip,html,aspx,java,php,svg,pdf",
						     "-x", "300,301,400,401,402,403,404,405,429"],
						    stdout=subprocess.PIPE,
						    stderr=subprocess.PIPE,
						    universal_newlines=True
						)
    


while len(running_scans) > 0:
    for i in running_scans:
        if i.poll() != None:
            status = 'Scanned'
            audit_status = 'Scanning'
            if len(running_scans) == 1:
                audit_status = 'Scanned'
            output, errors = i.communicate()
            if errors:
                status = 'Failed'
                output = errors
            
            data = {
                    'email':args.email,
                    'Audit':args.name,
                    'Scan':all_scan[i],
                    'Result':output,
                    'Status':status,
                    'Error':errors,
                    'Audit_status':audit_status
                    }
            r = requests.post(url = API_ENDPOINT, data = data)
            if r.text == '200 ok':
                running_scans.remove(i)
